<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Admina - Serwery</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
:root {
    --bg-primary: #000000;
    --bg-secondary: #111111;
    --bg-tertiary: #1a1a1a;
    --bg-hover: #222222;
    --text-primary: #ffffff;
    --text-secondary: #cccccc;
    --text-tertiary: #888888;
    --border-primary: #333333;
    --border-secondary: #444444;
    --accent-blue: #0066cc;
    --accent-blue-hover: #0052a3;
    --accent-red: #cc0000;
    --accent-green: #00cc66;
    --accent-yellow: #cc9900;
    --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
    --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
    --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
}

body {
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    font-size: 14px;
    line-height: 1.5;
}

.container {
    display: grid;
    grid-template-columns: 260px 1fr;
    min-height: 100vh;
}

.sidebar {
    background: var(--bg-secondary);
    border-right: 1px solid var(--border-primary);
    padding: 24px 0;
    position: sticky;
    top: 0;
    height: 100vh;
    overflow-y: auto;
}

.sidebar-header {
    padding: 0 24px 24px;
    border-bottom: 1px solid var(--border-primary);
    margin-bottom: 24px;
}

.sidebar-header h2 {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 4px;
    color: var(--text-primary);
    letter-spacing: -0.3px;
}

.sidebar-header p {
    color: var(--text-tertiary);
    font-size: 12px;
    font-weight: 400;
}

.nav-list {
    padding: 0 16px;
}

.nav-item {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    color: var(--text-secondary);
    text-decoration: none;
    border-radius: 8px;
    margin-bottom: 4px;
    transition: all 0.2s ease;
    cursor: pointer;
    font-weight: 500;
    font-size: 14px;
}

.nav-item i {
    margin-right: 12px;
    width: 20px;
    text-align: center;
    font-size: 16px;
}

.nav-item.active {
    background: var(--accent-blue);
    color: white;
}

.nav-item:hover:not(.active) {
    background: var(--bg-hover);
    color: var(--text-primary);
}

.nav-item .badge {
    margin-left: auto;
    background: var(--accent-blue);
    color: white;
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 12px;
    font-weight: 600;
}

.main-content {
    padding: 32px;
    overflow-y: auto;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 32px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border-primary);
}

.header h1 {
    font-size: 28px;
    font-weight: 700;
    letter-spacing: -0.5px;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 16px;
}

.logout-btn {
    padding: 8px 20px;
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
    font-size: 13px;
}

.logout-btn:hover {
    background: var(--accent-red);
    color: white;
    border-color: var(--accent-red);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
}

.stat-card {
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 24px;
    border: 1px solid var(--border-primary);
    transition: all 0.2s ease;
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--accent-blue);
}

.stat-card:hover {
    border-color: var(--border-secondary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.stat-value {
    font-size: 32px;
    font-weight: 800;
    margin-bottom: 4px;
    color: var(--text-primary);
}

.stat-label {
    color: var(--text-tertiary);
    font-size: 13px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 28px;
    background: var(--bg-secondary);
    padding: 4px;
    border-radius: 10px;
    border: 1px solid var(--border-primary);
    width: fit-content;
}

.tab {
    padding: 10px 24px;
    background: transparent;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    font-weight: 600;
    border-radius: 8px;
    transition: all 0.2s ease;
    font-size: 14px;
}

.tab.active {
    background: var(--accent-blue);
    color: white;
}

.servers-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
    gap: 24px;
}

.server-card {
    background: var(--bg-secondary);
    border-radius: 12px;
    padding: 24px;
    border: 1px solid var(--border-primary);
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
}

.server-card:hover {
    border-color: var(--border-secondary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.server-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
}

.server-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
}

.server-id {
    font-family: 'Roboto Mono', 'Consolas', monospace;
    color: var(--text-tertiary);
    font-size: 11px;
    background: var(--bg-primary);
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid var(--border-primary);
}

.players-list {
    flex-grow: 1;
    margin-bottom: 20px;
    max-height: 300px;
    overflow-y: auto;
}

.players-list::-webkit-scrollbar {
    width: 6px;
}

.players-list::-webkit-scrollbar-track {
    background: var(--bg-primary);
    border-radius: 3px;
}

.players-list::-webkit-scrollbar-thumb {
    background: var(--border-primary);
    border-radius: 3px;
}

.players-list::-webkit-scrollbar-thumb:hover {
    background: var(--border-secondary);
}

.player-item {
    display: flex;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid var(--border-primary);
}

.player-item:last-child {
    border-bottom: none;
}

.player-avatar {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    margin-right: 12px;
    object-fit: cover;
    border: 1px solid var(--border-primary);
}

.player-info {
    flex-grow: 1;
}

.player-name {
    font-weight: 600;
    color: var(--text-primary);
    text-decoration: none;
    transition: color 0.2s ease;
    display: block;
    margin-bottom: 2px;
}

.player-name:hover {
    color: var(--accent-blue);
}

.player-id {
    font-size: 11px;
    color: var(--text-tertiary);
    font-family: 'Roboto Mono', 'Consolas', monospace;
}

.playtime {
    color: var(--text-secondary);
    font-size: 12px;
    font-weight: 600;
    white-space: nowrap;
    margin-left: 12px;
    background: var(--bg-primary);
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid var(--border-primary);
}

.server-actions {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-top: 20px;
}

.action-btn {
    padding: 10px 12px;
    border: 1px solid var(--border-primary);
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 12px;
    transition: all 0.2s ease;
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    text-align: center;
}

.action-btn i {
    margin-right: 6px;
}

.action-btn.kick-btn:hover {
    background: var(--accent-yellow);
    color: white;
    border-color: var(--accent-yellow);
}

.action-btn.ban-btn:hover {
    background: var(--accent-red);
    color: white;
    border-color: var(--accent-red);
}

.action-btn.unban-btn:hover {
    background: var(--accent-green);
    color: white;
    border-color: var(--accent-green);
}

.action-btn.shutdown-btn {
    grid-column: 1 / -1;
    background: var(--accent-red);
    color: white;
    padding: 12px;
    border: none;
    font-size: 13px;
    margin-top: 8px;
}

.action-btn.shutdown-btn:hover {
    background: #990000;
}

.tab-content {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(4px);
}

.modal-content {
    background: var(--bg-secondary);
    border-radius: 16px;
    padding: 32px;
    width: 90%;
    max-width: 480px;
    border: 1px solid var(--border-primary);
    animation: modalSlide 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: var(--shadow-lg);
}

@keyframes modalSlide {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.modal-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--text-primary);
}

.modal-close {
    background: none;
    border: none;
    color: var(--text-tertiary);
    font-size: 24px;
    cursor: pointer;
    padding: 4px;
    line-height: 1;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: all 0.2s ease;
}

.modal-close:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
}

.modal-input {
    width: 100%;
    padding: 14px 16px;
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 14px;
    margin-bottom: 16px;
    transition: all 0.2s ease;
    font-weight: 400;
}

.modal-input:focus {
    outline: none;
    border-color: var(--accent-blue);
    background: var(--bg-tertiary);
}

.modal-input::placeholder {
    color: var(--text-tertiary);
}

.modal-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 24px;
}

.modal-btn {
    padding: 12px 24px;
    border: 1px solid var(--border-primary);
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s ease;
    font-size: 14px;
    min-width: 100px;
}

.modal-btn.cancel {
    background: var(--bg-tertiary);
    color: var(--text-secondary);
}

.modal-btn.cancel:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
}

.modal-btn.confirm {
    background: var(--accent-blue);
    color: white;
    border-color: var(--accent-blue);
}

.modal-btn.confirm:hover {
    background: var(--accent-blue-hover);
    border-color: var(--accent-blue-hover);
}

.toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--accent-blue);
    color: white;
    padding: 16px 24px;
    border-radius: 10px;
    box-shadow: var(--shadow-lg);
    display: none;
    z-index: 1001;
    animation: toastSlide 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    max-width: 400px;
    font-weight: 500;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

@keyframes toastSlide {
    from {
        opacity: 0;
        transform: translateX(100px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.players-table, .bans-list, .logs-container {
    background: var(--bg-secondary);
    border-radius: 12px;
    border: 1px solid var(--border-primary);
    padding: 24px;
}

.players-table .player-item {
    display: grid;
    grid-template-columns: 40px 1fr auto auto auto;
    align-items: center;
    gap: 16px;
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 8px;
    background: var(--bg-tertiary);
}

.players-table .player-item:hover {
    background: var(--bg-hover);
}

.players-table .action-btn {
    padding: 8px 16px;
    min-width: 80px;
}

@media (max-width: 1200px) {
    .servers-grid {
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    }
}

@media (max-width: 1024px) {
    .container {
        grid-template-columns: 1fr;
    }
    
    .sidebar {
        display: none;
    }
    
    .servers-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .main-content {
        padding: 24px 16px;
    }
    
    .header {
        flex-direction: column;
        gap: 16px;
        align-items: flex-start;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .server-actions {
        grid-template-columns: 1fr;
    }
    
    .players-table .player-item {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .modal-content {
        padding: 24px;
        margin: 16px;
    }
}

.status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
}

.status-online { background: var(--accent-green); }
.status-offline { background: var(--accent-red); }
.status-warning { background: var(--accent-yellow); }

::selection {
    background: rgba(0, 102, 204, 0.3);
    color: white;
}

.fade-in {
    animation: fadeIn 0.5s ease;
}
</style>
</head>
<body>
<div class="container">
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>Panel Admina</h2>
            <p>System zarządzania serwerami</p>
        </div>
        <div class="nav-list">
            <div class="nav-item active" onclick="showTab('servers')">
                <i class="fas fa-server"></i> Serwery
                <span class="badge" id="serversCount">0</span>
            </div>
            <div class="nav-item" onclick="showTab('players')">
                <i class="fas fa-users"></i> Gracze
                <span class="badge" id="playersCount">0</span>
            </div>
            <div class="nav-item" onclick="showTab('bans')">
                <i class="fas fa-ban"></i> Bany
                <span class="badge" id="bansCount">0</span>
            </div>
            <div class="nav-item" onclick="showTab('logs')">
                <i class="fas fa-clipboard-list"></i> Logi
            </div>
        </div>
    </div>
    
    <div class="main-content">
        <div class="header">
            <h1>Zarządzanie serwerami</h1>
            <div class="user-info">
                <span>Witaj, <strong style="color: var(--accent-blue);">admin</strong></span>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Wyloguj
                </button>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalServers">0</div>
                <div class="stat-label">Aktywnych serwerów</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalPlayers">0</div>
                <div class="stat-label">Łącznie graczy</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalBans">0</div>
                <div class="stat-label">Aktywnych banów</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="uptime">100%</div>
                <div class="stat-label">Dostępność API</div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('servers')">
                <i class="fas fa-server"></i> Serwery
            </button>
            <button class="tab" onclick="showTab('players')">
                <i class="fas fa-users"></i> Gracze
            </button>
            <button class="tab" onclick="showTab('bans')">
                <i class="fas fa-ban"></i> Bany
            </button>
            <button class="tab" onclick="showTab('logs')">
                <i class="fas fa-clipboard-list"></i> Logi
            </button>
        </div>
        
        <div id="serversTab" class="tab-content fade-in">
            <div class="servers-grid" id="serversContainer">
                <!-- Serwery będą ładowane dynamicznie -->
                <div class="server-card">
                    <div class="server-header">
                        <div class="server-title">Ładowanie serwerów...</div>
                        <div class="server-id">ID: ---</div>
                    </div>
                    <div class="players-list">
                        <div class="player-item">
                            <div class="player-info">
                                <div class="player-name">Trwa pobieranie danych</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="playersTab" class="tab-content fade-in" style="display: none;">
            <div class="players-table" id="playersContainer">
                <!-- Lista wszystkich graczy -->
                <div style="text-align: center; padding: 40px; color: var(--text-tertiary);">
                    <i class="fas fa-users" style="font-size: 48px; margin-bottom: 16px;"></i>
                    <div>Ładowanie listy graczy...</div>
                </div>
            </div>
        </div>
        
        <div id="bansTab" class="tab-content fade-in" style="display: none;">
            <div class="bans-list" id="bansContainer">
                <!-- Lista banów -->
                <div style="text-align: center; padding: 40px; color: var(--text-tertiary);">
                    <i class="fas fa-ban" style="font-size: 48px; margin-bottom: 16px;"></i>
                    <div>Ładowanie listy banów...</div>
                </div>
            </div>
        </div>
        
        <div id="logsTab" class="tab-content fade-in" style="display: none;">
            <div class="logs-container" id="logsContainer">
                <!-- Logi systemowe -->
                <div style="text-align: center; padding: 40px; color: var(--text-tertiary);">
                    <i class="fas fa-clipboard-list" style="font-size: 48px; margin-bottom: 16px;"></i>
                    <div>Ładowanie logów systemowych...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modale -->
<div id="kickModal" class="modal">
    <option value="all">Wszystkie serwery</option>
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-user-slash"></i> Wykop gracza</h3>
            <button class="modal-close" onclick="closeModal('kickModal')">&times;</button>
        </div>
        <input type="text" id="kickPlayerId" class="modal-input" placeholder="ID gracza lub nazwa" readonly>
        <input type="text" id="kickReason" class="modal-input" placeholder="Powód wykopania (wymagane)" autofocus>
        <div class="modal-actions">
            <button class="modal-btn cancel" onclick="closeModal('kickModal')">Anuluj</button>
            <button class="modal-btn confirm" onclick="confirmKick()">
                <i class="fas fa-check"></i> Wykop
            </button>
        </div>
    </div>
</div>

<div id="banModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-ban"></i> Zbanuj gracza</h3>
            <button class="modal-close" onclick="closeModal('banModal')">&times;</button>
        </div>
        <input type="text" id="banPlayerId" class="modal-input" placeholder="ID gracza lub nazwa" readonly>
        <input type="text" id="banReason" class="modal-input" placeholder="Powód bana (wymagane)" autofocus>
        <input type="number" id="banDuration" class="modal-input" placeholder="Czas trwania (godziny, 0 = permanentnie)" min="0" step="1">
        <div class="modal-actions">
            <button class="modal-btn cancel" onclick="closeModal('banModal')">Anuluj</button>
            <button class="modal-btn confirm" onclick="confirmBan()">
                <i class="fas fa-check"></i> Zbanuj
            </button>
        </div>
    </div>
</div>

<div id="shutdownModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-power-off"></i> Wyłącz serwer</h3>
            <button class="modal-close" onclick="closeModal('shutdownModal')">&times;</button>
        </div>
        <input type="text" id="shutdownServerId" class="modal-input" placeholder="ID serwera" readonly>
        <input type="text" id="shutdownReason" class="modal-input" placeholder="Powód wyłączenia (wymagane)" autofocus>
        <div class="modal-actions">
            <button class="modal-btn cancel" onclick="closeModal('shutdownModal')">Anuluj</button>
            <button class="modal-btn confirm" onclick="confirmShutdown()">
                <i class="fas fa-check"></i> Wyłącz
            </button>
        </div>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
const API_KEY = "SECRET_KEY_123";
const BACKEND_URL = "https://backrobloxserver.vercel.app";

let currentKickPlayer = {};
let currentBanPlayer = {};
let currentServerId = "";

function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
    });
    
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    
    document.getElementById(tabName + 'Tab').style.display = 'block';
    event.target.closest('.tab, .nav-item').classList.add('active');
    
    if (tabName === 'players') loadAllPlayers();
    if (tabName === 'bans') loadBans();
    if (tabName === 'logs') loadLogs();
}

function openModal(modalId, data = {}) {
    if (modalId === 'kickModal') {
        document.getElementById('kickPlayerId').value = data.playerName || 'Wybierz gracza';
        currentKickPlayer = data;
        document.getElementById('kickReason').focus();
    } else if (modalId === 'banModal') {
        document.getElementById('banPlayerId').value = data.playerName || 'Wybierz gracza';
        currentBanPlayer = data;
        document.getElementById('banReason').focus();
    } else if (modalId === 'shutdownModal') {
        document.getElementById('shutdownServerId').value = data.serverId || '';
        currentServerId = data.serverId;
        document.getElementById('shutdownReason').focus();
    }
    
    document.getElementById(modalId).style.display = 'flex';
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    
    const inputs = document.querySelectorAll(`#${modalId} .modal-input`);
    inputs.forEach(input => {
        if (!input.hasAttribute('readonly')) {
            input.value = '';
        }
    });
}

function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    
    let icon = 'fa-check-circle';
    if (type === 'error') icon = 'fa-times-circle';
    if (type === 'warning') icon = 'fa-exclamation-triangle';
    if (type === 'info') icon = 'fa-info-circle';
    
    toast.innerHTML = `
        <i class="fas ${icon}" style="margin-right: 12px;"></i>
        ${message}
    `;
    
    toast.style.background = type === 'success' ? '#00cc66' : 
                            type === 'error' ? '#cc0000' : 
                            type === 'warning' ? '#cc9900' : '#0066cc';
    
    toast.style.display = 'block';
    
    setTimeout(() => {
        toast.style.display = 'none';
    }, 4000);
}

async function loadServers() {
    try {
        const res = await fetch(BACKEND_URL + "/servers");
        const servers = await res.json();
        const container = document.getElementById("serversContainer");
        
        let totalPlayers = 0;
        container.innerHTML = "";
        
        servers.forEach(server => {
            totalPlayers += server.playerCount;
            
            const serverCard = document.createElement("div");
            serverCard.className = "server-card";
            
            const playersHtml = server.players
                .sort((a, b) => b.playtime - a.playtime)
                .map(p => `
                    <div class="player-item">
                        <img src="${p.avatar}" alt="${p.name}" class="player-avatar" 
                             onerror="this.src='https://www.roblox.com/headshot-thumbnail/image?userId=${p.userId}&width=420&height=420&format=png'">
                        <div class="player-info">
                            <a href="https://www.roblox.com/users/${p.userId}/profile" target="_blank" class="player-name">
                                ${p.name}
                            </a>
                            <div class="player-id">ID: ${p.userId}</div>
                        </div>
                        <div class="playtime" title="Czas gry">
                            ${formatPlayTime(p.playtime)}
                        </div>
                        <button class="action-btn kick-btn" onclick="openModal('kickModal', {playerId: ${p.userId}, playerName: '${p.name}'})">
                            <i class="fas fa-user-slash"></i> Kick
                        </button>
                        <button class="action-btn ban-btn" onclick="openModal('banModal', {playerId: ${p.userId}, playerName: '${p.name}'})">
                            <i class="fas fa-ban"></i> Ban
                        </button>
                    </div>
                `).join('');
            
            serverCard.innerHTML = `
                <div class="server-header">
                    <div class="server-title">
                        <span class="status-indicator status-online"></span>
                        ${server.playerCount} graczy online
                    </div>
                    <div class="server-id">ID: ${server.instanceId}</div>
                </div>
                
                <div class="players-list">
                    ${playersHtml || '<div style="text-align: center; padding: 20px; color: var(--text-tertiary);">Brak graczy online</div>'}
                </div>
                
                <div class="server-actions">
                    <button class="action-btn kick-btn" onclick="openModal('kickModal', {playerId: '', playerName: 'Wybierz gracza'})">
                        <i class="fas fa-user-slash"></i> Kick
                    </button>
                    <button class="action-btn ban-btn" onclick="openModal('banModal', {playerId: '', playerName: 'Wybierz gracza'})">
                        <i class="fas fa-ban"></i> Ban
                    </button>
                    <button class="action-btn unban-btn" onclick="showToast('Przejdź do zakładki "Bany" aby odbanować gracza', 'info')">
                        <i class="fas fa-unlock"></i> Unban
                    </button>
                    <button class="action-btn shutdown-btn" onclick="openModal('shutdownModal', {serverId: '${server.instanceId}'})">
                        <i class="fas fa-power-off"></i> Wyłącz serwer
                    </button>
                </div>
            `;
            
            container.appendChild(serverCard);
        });
        
        document.getElementById('totalServers').textContent = servers.length;
        document.getElementById('totalPlayers').textContent = totalPlayers;
        document.getElementById('serversCount').textContent = servers.length;
        document.getElementById('playersCount').textContent = totalPlayers;
        
    } catch (error) {
        console.error("Błąd ładowania serwerów:", error);
        showToast('Błąd połączenia z serwerem API', 'error');
    }
}

function formatPlayTime(seconds) {
    if (seconds < 60) return `${seconds}s`;
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    return `${hours}h ${minutes}m`;
}

async function loadAllPlayers() {
    try {
        const res = await fetch(BACKEND_URL + "/servers");
        const servers = await res.json();
        const container = document.getElementById("playersContainer");
        
        let allPlayers = [];
        servers.forEach(server => {
            allPlayers = allPlayers.concat(server.players.map(p => ({
                ...p,
                serverId: server.instanceId
            })));
        });
        
        const uniquePlayers = Array.from(new Map(allPlayers.map(p => [p.userId, p])).values());
        
        const playersHtml = uniquePlayers
            .sort((a, b) => b.playtime - a.playtime)
            .map(p => `
                <div class="player-item">
                    <img src="${p.avatar}" alt="${p.name}" class="player-avatar"
                         onerror="this.src='https://www.roblox.com/headshot-thumbnail/image?userId=${p.userId}&width=420&height=420&format=png'">
                    <div class="player-info">
                        <a href="https://www.roblox.com/users/${p.userId}/profile" target="_blank" class="player-name">
                            ${p.name}
                        </a>
                        <div class="player-id">ID: ${p.userId} | Serwer: ${p.serverId}</div>
                    </div>
                    <div class="playtime" title="Łączny czas gry">
                        ${formatPlayTime(p.playtime)}
                    </div>
                    <button class="action-btn kick-btn" onclick="openModal('kickModal', {playerId: ${p.userId}, playerName: '${p.name}'})">
                        <i class="fas fa-user-slash"></i> Kick
                    </button>
                    <button class="action-btn ban-btn" onclick="openModal('banModal', {playerId: ${p.userId}, playerName: '${p.name}'})">
                        <i class="fas fa-ban"></i> Ban
                    </button>
                </div>
            `).join('');
        
        container.innerHTML = `
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div style="font-weight: 600; color: var(--text-primary);">
                    <i class="fas fa-users"></i> Łącznie: ${uniquePlayers.length} unikalnych graczy
                </div>
                <div style="color: var(--text-tertiary); font-size: 13px;">
                    Sortowanie: czas gry (malejąco)
                </div>
            </div>
            ${playersHtml || '<div style="text-align: center; padding: 40px; color: var(--text-tertiary);">Brak aktywnych graczy</div>'}
        `;
        
    } catch (error) {
        console.error("Błąd ładowania graczy:", error);
        showToast('Błąd ładowania listy graczy', 'error');
    }
}

async function loadBans() {
    const container = document.getElementById("bansContainer");
    
    try {
        const res = await fetch(BACKEND_URL + "/bans");
        const bans = await res.json();
        
        document.getElementById('totalBans').textContent = bans.length;
        document.getElementById('bansCount').textContent = bans.length;
        
        const bansHtml = bans.map(ban => {
            const bannedDate = new Date(ban.bannedAt);
            const expiresDate = ban.expiresAt ? new Date(ban.expiresAt) : null;
            const now = new Date();
            const isExpired = expiresDate && expiresDate < now;
            
            return `
                <div class="player-item">
                    <div class="player-info">
                        <div class="player-name">${ban.playerName}</div>
                        <div class="player-id">ID: ${ban.playerId} | Admin: ${ban.bannedBy}</div>
                        <div class="player-id" style="color: ${isExpired ? '#00cc66' : '#cc0000'}">
                            ${ban.reason} | Zbanowano: ${bannedDate.toLocaleString('pl-PL')}
                            ${expiresDate ? ` | Wygasa: ${expiresDate.toLocaleString('pl-PL')}` : ' | Permanentny'}
                            ${isExpired ? ' <span style="color: #00cc66;">(WYGASŁ)</span>' : ''}
                        </div>
                    </div>
                    <button class="action-btn unban-btn" onclick="unbanPlayer(${ban.playerId})">
                        <i class="fas fa-unlock"></i> Unban
                    </button>
                </div>
            `;
        }).join('');
        
        container.innerHTML = `
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div style="font-weight: 600; color: var(--text-primary);">
                    <i class="fas fa-ban"></i> Aktywne bany: ${bans.length}
                </div>
                <div style="color: var(--text-tertiary); font-size: 13px;">
                    Czerwony = aktywny, Zielony = wygasły
                </div>
            </div>
            ${bansHtml || '<div style="text-align: center; padding: 40px; color: var(--text-tertiary);">Brak aktywnych banów</div>'}
        `;
        
    } catch (error) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--text-tertiary);">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
                <div>Błąd ładowania listy banów</div>
            </div>
        `;
    }
}

async function loadLogs() {
    const container = document.getElementById("logsContainer");
    
    try {
        const res = await fetch(BACKEND_URL + "/logs");
        const logs = await res.json();
        
        const logsHtml = logs
            .sort((a, b) => b.timestamp - a.timestamp)
            .map(log => {
                const date = new Date(log.timestamp);
                let icon = 'fa-info-circle';
                let color = '#0066cc';
                
                if (log.type === 'error') {
                    icon = 'fa-times-circle';
                    color = '#cc0000';
                } else if (log.type === 'warning') {
                    icon = 'fa-exclamation-triangle';
                    color = '#cc9900';
                } else if (log.type === 'success') {
                    icon = 'fa-check-circle';
                    color = '#00cc66';
                }
                
                return `
                    <div style="padding: 12px; border-bottom: 1px solid var(--border-primary); display: flex; align-items: flex-start;">
                        <i class="fas ${icon}" style="color: ${color}; margin-right: 12px; margin-top: 2px;"></i>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; color: var(--text-primary); margin-bottom: 4px;">
                                ${log.message}
                            </div>
                            <div style="font-size: 11px; color: var(--text-tertiary); font-family: 'Roboto Mono', monospace;">
                                ${date.toLocaleString('pl-PL')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        
        container.innerHTML = `
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div style="font-weight: 600; color: var(--text-primary);">
                    <i class="fas fa-clipboard-list"></i> Logi systemowe (ostatnie 50)
                </div>
                <button class="action-btn" onclick="loadLogs()" style="padding: 8px 16px;">
                    <i class="fas fa-sync-alt"></i> Odśwież
                </button>
            </div>
            <div style="max-height: 500px; overflow-y: auto; background: var(--bg-primary); border-radius: 8px; border: 1px solid var(--border-primary);">
                ${logsHtml || '<div style="text-align: center; padding: 40px; color: var(--text-tertiary);">Brak logów</div>'}
            </div>
        `;
        
    } catch (error) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--text-tertiary);">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 16px;"></i>
                <div>Błąd ładowania logów systemowych</div>
            </div>
        `;
    }
}

async function confirmKick() {
    const reason = document.getElementById('kickReason').value.trim();
    const serverId = document.getElementById('kickServer').value;
    
    if (!reason) {
        showToast('Podaj powód wykopania', 'warning');
        document.getElementById('kickReason').focus();
        return;
    }
    
    try {
        const response = await fetch(BACKEND_URL + "/kick", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "Authorization": API_KEY
            },
            body: JSON.stringify({
                playerId: currentKickPlayer.playerId,
                playerName: currentKickPlayer.playerName,
                reason: reason,
                serverId: serverId === "all" ? null : serverId
            })
        });
        
        if (response.ok) {
            showToast(`Gracz ${currentKickPlayer.playerName} został wykopany ${serverId === "all" ? 'ze wszystkich serwerów' : 'z serwera ' + serverId}`, 'success');
            closeModal('kickModal');
        } else {
            showToast('Błąd podczas wykopania gracza', 'error');
        }
    } catch (error) {
        showToast('Błąd połączenia z API', 'error');
    }
}

async function confirmBan() {
    const reason = document.getElementById('banReason').value.trim();
    const duration = parseInt(document.getElementById('banDuration').value) || 0;
    
    if (!reason) {
        showToast('Podaj powód bana', 'warning');
        document.getElementById('banReason').focus();
        return;
    }
    
    try {
        const response = await fetch(BACKEND_URL + "/ban", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "Authorization": API_KEY
            },
            body: JSON.stringify({
                playerId: currentBanPlayer.playerId,
                playerName: currentBanPlayer.playerName,
                reason: reason,
                duration: duration
            })
        });
        
        if (response.ok) {
            showToast(`Gracz ${currentBanPlayer.playerName} został zbanowany`, 'success');
            closeModal('banModal');
            loadBans();
        } else {
            showToast('Błąd podczas banowania gracza', 'error');
        }
    } catch (error) {
        showToast('Błąd połączenia z API', 'error');
    }
}

async function confirmShutdown() {
    const reason = document.getElementById('shutdownReason').value.trim();
    if (!reason) {
        showToast('Podaj powód wyłączenia', 'warning');
        document.getElementById('shutdownReason').focus();
        return;
    }
    
    try {
        const response = await fetch(BACKEND_URL + "/shutdown", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                serverId: currentServerId,
                reason: reason,
                apiKey: API_KEY
            })
        });
        
        if (response.ok) {
            showToast(`Serwer ${currentServerId} zostanie wyłączony`, 'success');
            closeModal('shutdownModal');
        } else {
            showToast('Błąd podczas wyłączania serwera', 'error');
        }
    } catch (error) {
        showToast('Funkcja wyłączania serwera jest obecnie niedostępna', 'warning');
    }
}

async function unbanPlayer(playerId) {
    if (!confirm('Czy na pewno chcesz odbanować tego gracza?')) return;
    
    try {
        const response = await fetch(BACKEND_URL + "/unban", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "Authorization": API_KEY
            },
            body: JSON.stringify({
                playerId: playerId
            })
        });
        
        if (response.ok) {
            showToast('Gracz został odbanowany', 'success');
            loadBans();
        } else {
            showToast('Błąd podczas odbanowywania', 'error');
        }
    } catch (error) {
        showToast('Błąd połączenia z API', 'error');
    }
}

function logout() {
    if (confirm('Czy na pewno chcesz się wylogować?')) {
        localStorage.removeItem('admin_authenticated');
        window.location.href = '/';
    }
}

if (!localStorage.getItem('admin_authenticated')) {
    window.location.href = '/';
}

loadServers();
setInterval(loadServers, 5000);

setInterval(() => {
    const uptimeEl = document.getElementById('uptime');
    uptimeEl.textContent = '✓';
    uptimeEl.style.color = '#00cc66';
    
    setTimeout(() => {
        uptimeEl.textContent = '100%';
        uptimeEl.style.color = '';
    }, 500);
}, 10000);

window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeModal('kickModal');
        closeModal('banModal');
        closeModal('shutdownModal');
    }
});
</script>
</body>
</html>
